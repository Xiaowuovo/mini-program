# 🚀 新机器部署快速指南

> **10分钟完成项目部署！从Git克隆到运行成功。**

---

## 📦 你需要的文件

本项目已经为新机器部署准备好了所有必要的文件:

### 核心文件清单

- ✅ `DEPLOYMENT.md` - **完整的部署文档**（推荐详细阅读）
- ✅ `backend/init_database.sql` - **数据库初始化SQL脚本**
- ✅ `backend/init_db.bat` - **Windows一键初始化脚本**
- ✅ `backend/init_db.sh` - **Linux/Mac一键初始化脚本**
- ✅ `backend/.env.example` - **环境配置模板**
- ✅ `backend/数据库初始化说明.md` - **数据库详细说明**

---

## ⚡ 10分钟快速部署

### 前提条件

确保已安装:
- Python 3.8+
- MySQL 8.0+
- Git
- 微信开发者工具

### 第一步: 克隆项目 (1分钟)

```bash
# 从Git仓库克隆
git clone https://github.com/your-username/garden-miniprogram.git
cd garden-miniprogram
```

### 第二步: 初始化数据库 (2分钟)

```bash
cd backend

# Windows:
init_db.bat

# Linux/Mac:
chmod +x init_db.sh && ./init_db.sh

# 输入MySQL root密码（默认: 123456）
```

**这一步会:**
- ✅ 创建 garden_db 数据库
- ✅ 创建14张数据表
- ✅ 插入测试数据（用户、菜地、作物等）

### 第三步: 配置环境 (2分钟)

```bash
# 复制环境配置
copy .env.example .env    # Windows
cp .env.example .env      # Linux/Mac

# 编辑.env文件
notepad .env    # Windows
vim .env        # Linux/Mac
```

**必须修改的配置:**

```env
# 数据库密码（改成你的MySQL密码）
DATABASE_URL=mysql+pymysql://root:你的密码@localhost:3306/garden_db

# 微信小程序配置（从微信公众平台获取）
WECHAT_APPID=wx1234567890abcdef
WECHAT_SECRET=your_secret_key

# JWT密钥（生产环境必须改）
SECRET_KEY=your-super-secret-key-change-it
```

### 第四步: 安装依赖 (3分钟)

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\activate      # Windows PowerShell
venv\Scripts\activate.bat    # Windows CMD
source venv/bin/activate     # Linux/Mac

# 安装依赖
pip install -r requirements.txt

# 如果速度慢，使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 第五步: 启动后端 (1分钟)

```bash
# Windows:
run.bat

# Linux/Mac:
chmod +x start.sh && ./start.sh

# 或者直接用Python启动
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**验证:** 浏览器访问 http://localhost:8000/api/docs

### 第六步: 启动小程序 (1分钟)

1. 打开微信开发者工具
2. 导入项目 -> 选择 `miniprogram` 目录
3. 填入AppID（或使用测试号）
4. 详情 -> 本地设置 -> ✅ 勾选"不校验合法域名"
5. 点击"编译"

---

## ✅ 验证部署成功

### 后端验证

```bash
# 访问API文档
http://localhost:8000/api/docs

# 健康检查
http://localhost:8000/health
# 应返回: {"status": "healthy"}

# 根路径
http://localhost:8000/
# 应返回: {"message": "欢迎使用共享菜园云端小筑API", ...}
```

### 数据库验证

```bash
mysql -u root -p
USE garden_db;
SELECT COUNT(*) FROM gardens;  # 应返回 5
SELECT * FROM gardens;         # 查看菜地数据
EXIT;
```

### 小程序验证

- ✅ 模拟器显示首页
- ✅ 菜地列表能正常加载
- ✅ 控制台无报错
- ✅ 可以浏览菜地详情

---

## 🎯 核心数据说明

数据库初始化后会自动创建:

### 测试用户（3个）
- test_openid_001 - 测试用户1
- test_openid_002 - 测试用户2
- admin_openid_001 - 管理员

### 菜地数据（5个）
- 阳光菜地A区01号 (20㎡, 300元/月) - 可租用
- 阳光菜地A区02号 (15㎡, 250元/月) - 可租用
- 阳光菜地B区01号 (25㎡, 350元/月) - 已租出
- 阳光菜地B区02号 (30㎡, 400元/月) - 可租用
- 阳光菜地C区01号 (10㎡, 200元/月) - 维护中

### 作物数据（3种）
- 番茄 (含6个生长阶段规则)
- 生菜
- 黄瓜

---

## 🐛 常见问题快速解决

### 问题1: MySQL连接失败

```bash
# 检查MySQL服务
net start MySQL           # Windows
sudo systemctl start mysql  # Linux

# 检查密码是否正确
mysql -u root -p
```

### 问题2: pip install很慢

```bash
# 使用清华镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 问题3: 端口8000被占用

```bash
# Windows - 查找并结束进程
netstat -ano | findstr :8000
taskkill /PID <PID号> /F

# Linux - 查找并结束进程
lsof -i :8000
kill -9 <PID号>

# 或者使用其他端口
uvicorn app.main:app --port 8001
```

### 问题4: 小程序无法连接后端

**检查:**
1. 后端是否在运行（访问 http://localhost:8000/health）
2. 详情 -> 本地设置 -> ✅ 不校验合法域名
3. 检查 `miniprogram/utils/request.js` 中的 BASE_URL

### 问题5: 虚拟环境激活失败

```bash
# Windows PowerShell执行策略限制
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 然后重新激活
.\venv\Scripts\activate
```

---

## 📚 详细文档

如需更详细的说明，请查看:

- **完整部署文档**: `DEPLOYMENT.md`
- **数据库说明**: `backend/数据库初始化说明.md`
- **故障排查**: `TROUBLESHOOTING.md`
- **项目说明**: `README.md`

---

## 🎉 部署完成

如果以上所有验证都通过，恭喜！项目已成功部署到新机器。

**下一步:**
1. 开始开发或测试功能
2. 根据需要修改配置
3. 部署到生产环境（参考DEPLOYMENT.md）

---

## 💡 小贴士

### 保存配置

部署成功后，建议保存以下信息:

```
数据库名: garden_db
MySQL密码: [你的密码]
后端端口: 8000
小程序AppID: [你的AppID]
小程序Secret: [你的Secret]
```

### Git使用建议

```bash
# 不要提交敏感信息
git add .env     # ❌ 错误! .env包含敏感信息
git add .        # ✅ 正确! .gitignore已配置

# 定期提交代码
git add .
git commit -m "完成XXX功能"
git push
```

### 开发环境vs生产环境

- **开发环境**: DEBUG=True, localhost, 不校验域名
- **生产环境**: DEBUG=False, HTTPS域名, 严格配置

详见 `DEPLOYMENT.md` 的生产环境部署章节。

---

**文档版本**: v1.0.0
**最后更新**: 2024-12-10
**技术支持**: 查看 TROUBLESHOOTING.md
