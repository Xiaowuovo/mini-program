# 📊 数据库初始化说明

## 🎯 目的

本脚本用于在新机器上快速创建与开发环境完全相同的数据库结构和测试数据。

---

## 📁 相关文件

- `init_database.sql` - SQL初始化脚本（核心文件）
- `init_db.bat` - Windows一键初始化脚本
- `init_db.sh` - Linux/Mac一键初始化脚本

---

## 🚀 使用方法

### Windows系统

```bash
# 1. 进入backend目录
cd backend

# 2. 运行初始化脚本
init_db.bat

# 3. 输入MySQL root密码（默认: 123456）
```

### Linux/Mac系统

```bash
# 1. 进入backend目录
cd backend

# 2. 给脚本执行权限
chmod +x init_db.sh

# 3. 运行初始化脚本
./init_db.sh

# 4. 输入MySQL root密码
```

---

## 📋 脚本会创建什么

### 数据库

- **数据库名**: `garden_db`
- **字符集**: `utf8mb4`
- **排序规则**: `utf8mb4_unicode_ci`

### 数据表（14张）

1. **users** - 用户表
2. **gardens** - 菜地表
3. **orders** - 订单表
4. **posts** - 社区帖子表
5. **comments** - 评论表
6. **likes** - 点赞表
7. **services** - 增值服务表
8. **reminders** - 任务提醒表
9. **crops** - 作物基础信息表
10. **crop_growth_stages** - 作物生长阶段规则表
11. **iot_sensors** - 物联网传感器表
12. **iot_readings** - 物联网读数表
13. **planting_records** - 种植记录表
14. **smart_reminders** - 智能提醒记录表

### 测试数据

#### 用户（3个）

| ID | OpenID | 昵称 | 角色 |
|----|--------|------|------|
| 1 | test_openid_001 | 测试用户1 | 租户 |
| 2 | test_openid_002 | 测试用户2 | 租户 |
| 3 | admin_openid_001 | 管理员 | 管理员 |

#### 菜地（5个）

| ID | 名称 | 面积(㎡) | 租金(元/月) | 状态 |
|----|------|---------|------------|------|
| 1 | 阳光菜地A区01号 | 20.00 | 300.00 | 可租用 |
| 2 | 阳光菜地A区02号 | 15.00 | 250.00 | 可租用 |
| 3 | 阳光菜地B区01号 | 25.00 | 350.00 | 已租出 |
| 4 | 阳光菜地B区02号 | 30.00 | 400.00 | 可租用 |
| 5 | 阳光菜地C区01号 | 10.00 | 200.00 | 维护中 |

#### 作物（3种）

| ID | 名称 | 类型 | 生长周期 | 难度 |
|----|------|------|---------|------|
| 1 | 番茄 | 蔬菜 | 90天 | 3级 |
| 2 | 生菜 | 蔬菜 | 60天 | 2级 |
| 3 | 黄瓜 | 蔬菜 | 70天 | 3级 |

#### 番茄生长阶段（6个阶段）

1. **播种期** (7天) - 保持土壤湿润
2. **苗期** (20天) - 适当控水促进根系发育
3. **生长期** (30天) - 开始搭架、修剪侧枝
4. **开花期** (15天) - 注意授粉、防止落花
5. **结果期** (15天) - 及时摘除老叶、保证通风
6. **收获期** (10天) - 分批采收、采收后及时追肥

---

## ✅ 验证初始化

初始化完成后，可以通过以下方式验证:

### 方法1: 命令行验证

```bash
# 登录MySQL
mysql -u root -p

# 查看数据库
SHOW DATABASES;
# 应该看到 garden_db

# 使用数据库
USE garden_db;

# 查看所有表
SHOW TABLES;
# 应该看到14张表

# 查看表数据
SELECT COUNT(*) FROM users;    # 应返回 3
SELECT COUNT(*) FROM gardens;  # 应返回 5
SELECT COUNT(*) FROM crops;    # 应返回 3

# 查看具体数据
SELECT id, name, area, price, status FROM gardens;

# 退出
EXIT;
```

### 方法2: 使用数据库工具

使用 Navicat、MySQL Workbench 等工具连接到 `garden_db`，检查表和数据。

---

## 🔧 常见问题

### 问题1: "Access denied for user 'root'"

**原因**: MySQL密码错误

**解决**:
1. 确认MySQL root密码
2. 如果忘记密码，需要重置MySQL root密码

### 问题2: "Can't connect to MySQL server"

**原因**: MySQL服务未启动

**解决**:
```bash
# Windows
net start MySQL

# Linux
sudo systemctl start mysql
```

### 问题3: "Database already exists"

**原因**: garden_db 数据库已存在

**解决**:
如果需要重新初始化:
```bash
mysql -u root -p
DROP DATABASE IF EXISTS garden_db;
EXIT;

# 然后重新运行初始化脚本
```

### 问题4: 初始化脚本执行失败

**原因**: 可能是SQL语法问题或权限问题

**解决**:
1. 检查MySQL版本是否为8.0+
2. 确认root用户有创建数据库的权限
3. 查看错误信息，根据提示修复

---

## 📝 自定义初始化

如果需要修改初始化数据，编辑 `init_database.sql` 文件:

### 添加更多菜地

在文件末尾的 `INSERT INTO gardens` 部分添加:

```sql
INSERT INTO gardens (name, area, price, status, location, images, description) VALUES
('你的菜地名称', 面积, 价格, '状态', '位置', '["图片URL"]', '描述');
```

### 添加更多作物

```sql
INSERT INTO crops (name, type, total_growth_days, difficulty, description) VALUES
('作物名称', '类型', 生长天数, 难度, '描述');
```

修改后，重新运行初始化脚本即可。

---

## 🔄 重新初始化

如果需要完全重新初始化数据库:

```bash
# 1. 删除旧数据库
mysql -u root -p
DROP DATABASE IF EXISTS garden_db;
EXIT;

# 2. 重新运行初始化脚本
# Windows:
init_db.bat

# Linux/Mac:
./init_db.sh
```

---

## 📧 技术支持

如果遇到无法解决的问题:

1. 检查 `init_database.sql` 文件是否完整
2. 检查MySQL版本是否符合要求（8.0+）
3. 查看MySQL错误日志
4. 参考项目 TROUBLESHOOTING.md 文档

---

**最后更新**: 2024-12-10
**版本**: v1.0.0
