<!--pages/order-detail/order-detail.wxml-->
<view class="container order-detail-page">
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:if="{{!loading && order}}" class="detail-content">
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-section">
      <view class="status-header">
        <view class="status-icon">
          {{order.status === 'pending' ? 'â°' : order.status === 'paid' ? 'âœ“' : order.status === 'active' ? 'ğŸŒ±' : order.status === 'completed' ? 'ğŸ‰' : 'âœ—'}}
        </view>
        <view class="status-info">
          <text class="status-text">
            {{order.status === 'pending' ? 'å¾…æ”¯ä»˜' : order.status === 'paid' ? 'å·²æ”¯ä»˜' : order.status === 'active' ? 'è¿›è¡Œä¸­' : order.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²å–æ¶ˆ'}}
          </text>
          <text class="status-desc">
            {{order.status === 'pending' ? 'è¯·å°½å¿«å®Œæˆæ”¯ä»˜' : order.status === 'paid' ? 'è®¢å•å·²æ”¯ä»˜ï¼Œç­‰å¾…å¼€å§‹' : order.status === 'active' ? 'ç§ŸæœŸè¿›è¡Œä¸­' : order.status === 'completed' ? 'æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨' : 'è®¢å•å·²å–æ¶ˆ'}}
          </text>
        </view>
      </view>

      <!-- çŠ¶æ€æ­¥éª¤æ¡ -->
      <view class="status-steps" wx:if="{{order.status !== 'cancelled'}}">
        <view
          wx:for="{{statusSteps}}"
          wx:key="key"
          class="step-item {{order.status === item.key || (order.status === 'completed' && index < 4) ? 'active' : ''}}"
        >
          <view class="step-dot"></view>
          <text class="step-label">{{item.label}}</text>
        </view>
      </view>
    </view>

    <!-- èœåœ°ä¿¡æ¯ -->
    <view class="garden-section" bindtap="viewGarden">
      <view class="section-header">
        <text class="section-title">èœåœ°ä¿¡æ¯</text>
        <text class="view-more">æŸ¥çœ‹è¯¦æƒ… ></text>
      </view>

      <view class="garden-card" wx:if="{{order.garden}}">
        <image
          src="{{order.garden.images && order.garden.images[0] ? order.garden.images[0] : '/images/default-garden.png'}}"
          class="garden-image"
          mode="aspectFill"
        ></image>
        <view class="garden-info">
          <text class="garden-name">{{order.garden.name}}</text>
          <text class="garden-spec">é¢ç§¯ï¼š{{order.garden.area}}ã¡</text>
          <text class="garden-location">ä½ç½®ï¼š{{order.garden.location}}</text>
        </view>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="info-section">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>

      <view class="info-list">
        <view class="info-item">
          <text class="info-label">è®¢å•ç¼–å·</text>
          <view class="info-value-wrapper">
            <text class="info-value">{{order.orderNo}}</text>
            <text class="copy-btn" catchtap="copyOrderNo">å¤åˆ¶</text>
          </view>
        </view>

        <view class="info-item">
          <text class="info-label">åˆ›å»ºæ—¶é—´</text>
          <text class="info-value">{{order.created_at_formatted}}</text>
        </view>

        <view class="info-item" wx:if="{{order.status === 'pending'}}">
          <text class="info-label">æ”¯ä»˜æˆªæ­¢</text>
          <text class="info-value warning">{{order.payment_deadline}}</text>
        </view>

        <view class="info-item">
          <text class="info-label">å¼€å§‹æ—¥æœŸ</text>
          <text class="info-value">{{order.start_date}}</text>
        </view>

        <view class="info-item">
          <text class="info-label">ç»“æŸæ—¥æœŸ</text>
          <text class="info-value">{{order.end_date}}</text>
        </view>

        <view class="info-item" wx:if="{{order.notes}}">
          <text class="info-label">å¤‡æ³¨ä¿¡æ¯</text>
          <text class="info-value">{{order.notes}}</text>
        </view>
      </view>
    </view>

    <!-- ä»·æ ¼æ˜ç»† -->
    <view class="price-section">
      <view class="section-title">ä»·æ ¼æ˜ç»†</view>

      <view class="price-list">
        <view class="price-item">
          <text class="price-label">ç§Ÿé‡‘</text>
          <text class="price-value">Â¥{{order.total_price}}</text>
        </view>

        <view class="price-divider"></view>

        <view class="price-item total">
          <text class="price-label">å®ä»˜æ¬¾</text>
          <text class="price-value">Â¥{{order.total_price}}</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œè®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰ -->
    <view class="timeline-section" wx:if="{{order.timeline && order.timeline.length > 0}}">
      <view class="section-title">æ“ä½œè®°å½•</view>

      <view class="timeline-list">
        <view wx:for="{{order.timeline}}" wx:key="index" class="timeline-item">
          <view class="timeline-dot"></view>
          <view class="timeline-content">
            <text class="timeline-title">{{item.title}}</text>
            <text class="timeline-time">{{item.time}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{!loading && order}}">
    <view class="bar-left">
      <view class="bar-btn" bindtap="contactService">
        <image src="/images/icon-service.png" class="bar-icon"></image>
        <text class="bar-text">å®¢æœ</text>
      </view>
    </view>

    <view class="bar-right">
      <!-- å¾…æ”¯ä»˜çŠ¶æ€ -->
      <block wx:if="{{order.status === 'pending'}}">
        <button class="action-btn secondary" bindtap="handleCancel">
          å–æ¶ˆè®¢å•
        </button>
        <button class="action-btn primary" bindtap="handlePay">
          ç«‹å³æ”¯ä»˜
        </button>
      </block>

      <!-- è¿›è¡Œä¸­çŠ¶æ€ -->
      <block wx:elif="{{order.status === 'active'}}">
        <button class="action-btn primary" bindtap="viewGarden">
          æŸ¥çœ‹èœåœ°
        </button>
      </block>

      <!-- å·²å®ŒæˆçŠ¶æ€ -->
      <block wx:elif="{{order.status === 'completed'}}">
        <navigator url="/pages/gardens/gardens" class="action-btn primary">
          å†æ¬¡ç§Ÿç”¨
        </navigator>
      </block>
    </view>
  </view>
</view>