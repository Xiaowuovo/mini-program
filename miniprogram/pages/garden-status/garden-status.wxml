<!--pages/garden-status/garden-status.wxml-->
<view class="container garden-status-page">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-state">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else>
    <!-- å¤´éƒ¨ä¿¡æ¯å¡ç‰‡ -->
    <view class="header-card">
      <view class="garden-header">
        <view class="garden-name">{{garden.name}}</view>
        <view class="garden-location">ğŸ“ {{garden.location}}</view>
      </view>

      <view class="rental-info">
        <view class="rental-item">
          <text class="label">ç§ŸæœŸå‰©ä½™</text>
          <text class="value highlight">{{rental.remaining_days}}å¤©</text>
        </view>
        <view class="rental-item">
          <text class="label">åˆ°æœŸæ—¥æœŸ</text>
          <text class="value">{{rental.end_date}}</text>
        </view>
      </view>
    </view>

    <!-- Tabåˆ‡æ¢ -->
    <view class="tab-bar">
      <view
        wx:for="{{tabs}}"
        wx:key="index"
        class="tab-item {{currentTab === index ? 'active' : ''}}"
        bindtap="onTabChange"
        data-index="{{index}}"
      >
        {{item}}
      </view>
    </view>

    <!-- Tabå†…å®¹ -->
    <view class="tab-content">
      <!-- æ¦‚è§ˆTab -->
      <view wx:if="{{currentTab === 0}}" class="tab-panel">
        <!-- ç¯å¢ƒå¥åº·å¡ç‰‡ -->
        <view class="status-card">
          <view class="card-header">
            <text class="card-title">ğŸŒ± ç¯å¢ƒå¥åº·</text>
            <view class="health-score" style="color: {{getEnvironmentStatusColor(environment.status)}}">
              {{environment.health_score}}åˆ†
            </view>
          </view>

          <view class="health-status">
            <view class="status-badge" style="background: {{getEnvironmentStatusColor(environment.status)}}">
              {{getEnvironmentStatusText(environment.status)}}
            </view>
          </view>

          <view wx:if="{{environment.alerts && environment.alerts.length > 0}}" class="alerts">
            <view wx:for="{{environment.alerts}}" wx:key="index" class="alert-item {{item.severity}}">
              âš ï¸ {{item.message}}
            </view>
          </view>
        </view>

        <!-- ç§æ¤æ¦‚å†µ -->
        <view class="status-card">
          <view class="card-header">
            <text class="card-title">ğŸŒ¾ ç§æ¤æ¦‚å†µ</text>
            <text class="card-subtitle">å…±{{planting.total_crops}}ç§ä½œç‰©</text>
          </view>

          <view wx:if="{{planting.total_crops === 0}}" class="empty-state">
            <text class="empty-text">æš‚æ— ç§æ¤è®°å½•</text>
            <text class="empty-hint">å¼€å§‹æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªä½œç‰©å§</text>
          </view>

          <view wx:else class="crop-list">
            <view
              wx:for="{{planting.records}}"
              wx:key="id"
              class="crop-item"
              bindtap="viewCropDetail"
              data-crop="{{item}}"
            >
              <view class="crop-info">
                <text class="crop-name">{{item.crop_name}}</text>
                <text class="crop-stage">{{getStageText(item.current_stage)}}</text>
              </view>
              <view class="crop-progress">
                <view class="progress-bar">
                  <view class="progress-fill" style="width: {{item.growth_progress}}%"></view>
                </view>
                <text class="progress-text">{{item.growth_progress}}%</text>
              </view>
            </view>
          </view>
        </view>

        <!-- æ™ºèƒ½æé†’ -->
        <view class="status-card" bindtap="goToReminders">
          <view class="card-header">
            <text class="card-title">ğŸ”” æ™ºèƒ½æé†’</text>
            <text class="card-badge">{{reminders.pending_count}}</text>
          </view>
          <view class="card-content">
            <text class="reminder-text">
              {{reminders.pending_count > 0 ? 'æœ‰' + reminders.pending_count + 'æ¡å¾…å¤„ç†æé†’' : 'æš‚æ— å¾…å¤„ç†æé†’'}}
            </text>
            <text class="arrow">â†’</text>
          </view>
        </view>

        <!-- å¿«æ·æ“ä½œ -->
        <view class="quick-actions">
          <view class="action-btn" bindtap="goToMonitor">
            <text class="action-icon">ğŸ“¹</text>
            <text class="action-text">è§†é¢‘ç›‘æ§</text>
          </view>
          <view class="action-btn" bindtap="goToReminders">
            <text class="action-icon">ğŸ“</text>
            <text class="action-text">ç®¡ç†æé†’</text>
          </view>
        </view>
      </view>

      <!-- ç§æ¤Tab -->
      <view wx:if="{{currentTab === 1}}" class="tab-panel">
        <view wx:if="{{planting.total_crops === 0}}" class="empty-state">
          <image src="/images/empty.png" class="empty-image"></image>
          <text class="empty-text">è¿˜æ²¡æœ‰ç§æ¤è®°å½•</text>
        </view>

        <view wx:else>
          <view
            wx:for="{{planting.records}}"
            wx:key="id"
            class="planting-card"
          >
            <view class="planting-header">
              <text class="crop-name-large">{{item.crop_name}}</text>
              <view class="stage-badge">{{getStageText(item.current_stage)}}</view>
            </view>

            <view class="planting-details">
              <view class="detail-row">
                <text class="detail-label">ç§æ¤æ—¥æœŸ</text>
                <text class="detail-value">{{item.planting_date}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">é¢„è®¡æ”¶è·</text>
                <text class="detail-value">{{item.expected_harvest_date}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">å·²ç”Ÿé•¿å¤©æ•°</text>
                <text class="detail-value">{{item.days_since_planting}}å¤©</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">è·ç¦»æ”¶è·</text>
                <text class="detail-value highlight">{{item.days_to_harvest}}å¤©</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">ç§æ¤æ•°é‡</text>
                <text class="detail-value">{{item.quantity}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">å åœ°é¢ç§¯</text>
                <text class="detail-value">{{item.area}}ã¡</text>
              </view>
            </view>

            <view class="growth-progress-section">
              <view class="progress-header">
                <text>ç”Ÿé•¿è¿›åº¦</text>
                <text class="progress-percent">{{item.growth_progress}}%</text>
              </view>
              <view class="progress-bar-large">
                <view class="progress-fill-large" style="width: {{item.growth_progress}}%"></view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç¯å¢ƒTab -->
      <view wx:if="{{currentTab === 2}}" class="tab-panel">
        <view wx:if="{{!environment.iot_data || !environment.iot_data.sensors}}" class="empty-state">
          <text class="empty-text">æš‚æ— ç‰©è”ç½‘æ•°æ®</text>
          <text class="empty-hint">ä¼ æ„Ÿå™¨æ­£åœ¨é…ç½®ä¸­</text>
        </view>

        <view wx:else>
          <view
            wx:for="{{environment.iot_data.sensors}}"
            wx:key="id"
            class="sensor-card {{item.is_abnormal ? 'abnormal' : ''}}"
            bindtap="viewSensorDetail"
            data-sensor="{{item}}"
          >
            <view class="sensor-header">
              <text class="sensor-type">
                {{item.sensor_type === 'temperature' ? 'ğŸŒ¡ï¸ æ¸©åº¦' :
                  item.sensor_type === 'humidity' ? 'ğŸ’§ æ¹¿åº¦' :
                  item.sensor_type === 'soil_moisture' ? 'ğŸŒ± åœŸå£¤æ¹¿åº¦' :
                  item.sensor_type === 'light' ? 'â˜€ï¸ å…‰ç…§' : 'ä¼ æ„Ÿå™¨'}}
              </text>
              <view wx:if="{{item.is_abnormal}}" class="abnormal-badge">å¼‚å¸¸</view>
            </view>

            <view class="sensor-value">
              <text class="value-number">{{item.current_value}}</text>
              <text class="value-unit">{{item.unit}}</text>
            </view>

            <view wx:if="{{item.is_abnormal}}" class="abnormal-reason">
              âš ï¸ {{item.abnormal_reason}}
            </view>

            <view class="sensor-time">
              æœ€åæ›´æ–°: {{item.last_reading_time}}
            </view>
          </view>
        </view>
      </view>

      <!-- æ•°æ®Tab -->
      <view wx:if="{{currentTab === 3}}" class="tab-panel">
        <view class="data-section">
          <view class="data-title">èœåœ°ä¿¡æ¯</view>
          <view class="data-item">
            <text class="data-label">é¢ç§¯</text>
            <text class="data-value">{{garden.area}}ã¡</text>
          </view>
          <view class="data-item">
            <text class="data-label">ä½ç½®</text>
            <text class="data-value">{{garden.location}}</text>
          </view>
          <view class="data-item">
            <text class="data-label">çŠ¶æ€</text>
            <text class="data-value">{{garden.status === 'rented' ? 'å·²ç§Ÿç”¨' : 'å¯ç§Ÿç”¨'}}</text>
          </view>
        </view>

        <view class="data-section">
          <view class="data-title">ç§Ÿèµä¿¡æ¯</view>
          <view class="data-item">
            <text class="data-label">è®¢å•å·</text>
            <text class="data-value">{{rental.order_id}}</text>
          </view>
          <view class="data-item">
            <text class="data-label">å¼€å§‹æ—¥æœŸ</text>
            <text class="data-value">{{rental.start_date}}</text>
          </view>
          <view class="data-item">
            <text class="data-label">ç»“æŸæ—¥æœŸ</text>
            <text class="data-value">{{rental.end_date}}</text>
          </view>
          <view class="data-item">
            <text class="data-label">å‰©ä½™å¤©æ•°</text>
            <text class="data-value highlight">{{rental.remaining_days}}å¤©</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
