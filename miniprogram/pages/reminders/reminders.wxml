<!--pages/reminders/reminders.wxml-->
<view class="container reminders-page">
  <!-- é¡¶éƒ¨æ¨ªå¹… -->
  <view class="header-banner">
    <view class="banner-content">
      <text class="banner-title">æ™ºèƒ½ä»»åŠ¡æé†’</text>
      <text class="banner-desc">ç§‘å­¦ç®¡ç†ï¼ŒåŠæ—¶æé†’</text>
    </view>
    <view class="banner-toggle">
      <text class="toggle-label">æ™ºèƒ½æé†’</text>
      <switch
        checked="{{useSmartReminders}}"
        bindchange="toggleSmartReminders"
        color="#4CAF50"
      />
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-card" wx:if="{{statistics}}">
    <view class="stat-item" bindtap="onFilterChange" data-status="all">
      <text class="stat-value">{{statistics.total}}</text>
      <text class="stat-label">å…¨éƒ¨ä»»åŠ¡</text>
    </view>
    <view class="stat-divider"></view>
    <view class="stat-item" bindtap="onFilterChange" data-status="pending">
      <text class="stat-value pending">{{statistics.pending}}</text>
      <text class="stat-label">å¾…å¤„ç†</text>
    </view>
    <view class="stat-divider"></view>
    <view class="stat-item" bindtap="onFilterChange" data-status="completed">
      <text class="stat-value completed">{{statistics.completed}}</text>
      <text class="stat-label">å·²å®Œæˆ</text>
    </view>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <view class="filter-section">
    <scroll-view class="filter-scroll" scroll-x show-scrollbar="{{false}}">
      <view class="filter-tabs">
        <view
          class="tab-item {{statusFilter === 'all' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="all"
        >
          <text class="tab-text">å…¨éƒ¨</text>
        </view>
        <view
          class="tab-item {{statusFilter === 'pending' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="pending"
        >
          <text class="tab-text">å¾…å®Œæˆ</text>
        </view>
        <view
          class="tab-item {{statusFilter === 'completed' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="completed"
        >
          <text class="tab-text">å·²å®Œæˆ</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æé†’åˆ—è¡¨ -->
  <view class="reminder-list">
    <view
      wx:for="{{reminders}}"
      wx:key="id"
      class="reminder-card {{item.status}} priority-{{item.priority}}"
    >
      <!-- å¡ç‰‡å¤´éƒ¨ -->
      <view class="reminder-header">
        <view class="header-left">
          <view class="icon-wrapper">
            <text class="reminder-icon">
              {{item.task_type === 'watering' ? 'ğŸ’§' :
                item.task_type === 'fertilizing' ? 'ğŸŒ¿' :
                item.task_type === 'weeding' ? 'ğŸŒ¾' :
                item.task_type === 'harvesting' || item.task_type === 'harvest' ? 'ğŸ¥¬' :
                item.task_type === 'pest_check' ? 'ğŸ›' :
                item.task_type === 'environment_alert' ? 'âš ï¸' : 'â°'}}
            </text>
          </view>
          <view class="reminder-info">
            <text class="reminder-title">{{item.title}}</text>
            <text class="reminder-garden" wx:if="{{item.garden_name}}">{{item.garden_name}}</text>
          </view>
        </view>

        <view class="header-right">
          <!-- ä¼˜å…ˆçº§å¾½ç«  -->
          <view class="priority-badge level-{{item.priority}}" wx:if="{{item.priority}}">
            {{item.priority === 5 ? 'ğŸ”´' : item.priority === 4 ? 'ğŸŸ ' : item.priority === 3 ? 'ğŸŸ¡' : 'ğŸŸ¢'}}
          </view>
          <!-- å®ŒæˆçŠ¶æ€ -->
          <view class="status-icon {{item.status}}" wx:if="{{item.status === 'completed'}}">
            <text>âœ“</text>
          </view>
        </view>
      </view>

      <!-- å¡ç‰‡å†…å®¹ -->
      <view class="reminder-content">
        <text class="reminder-desc">{{item.description}}</text>

        <!-- æ™ºèƒ½æé†’æ¥æº -->
        <view class="source-tag" wx:if="{{useSmartReminders && item.source}}">
          <text class="source-icon">
            {{item.source === 'iot_triggered' ? 'ğŸ””' :
              item.source === 'rule_based' ? 'ğŸ“‹' : 'âœï¸'}}
          </text>
          <text class="source-text">
            {{item.source === 'iot_triggered' ? 'ç‰©è”ç½‘é¢„è­¦' :
              item.source === 'rule_based' ? 'è§„åˆ™ç”Ÿæˆ' : 'æ‰‹åŠ¨æ·»åŠ '}}
          </text>
        </view>

        <!-- å…ƒæ•°æ®å±•ç¤º -->
        <view class="reminder-metadata" wx:if="{{useSmartReminders && item.metadata}}">
          <view class="metadata-item" wx:if="{{item.metadata.frequency}}">
            <text class="metadata-label">å»ºè®®é¢‘ç‡</text>
            <text class="metadata-value">æ¯{{item.metadata.frequency}}å¤©</text>
          </view>
          <view class="metadata-item" wx:if="{{item.metadata.watering_amount}}">
            <text class="metadata-label">æµ‡æ°´é‡</text>
            <text class="metadata-value">{{item.metadata.watering_amount}}å‡</text>
          </view>
          <view class="metadata-item" wx:if="{{item.metadata.fertilizer_type}}">
            <text class="metadata-label">è‚¥æ–™ç±»å‹</text>
            <text class="metadata-value">{{item.metadata.fertilizer_type}}</text>
          </view>
          <view class="metadata-item" wx:if="{{item.metadata.value}}">
            <text class="metadata-label">å½“å‰å€¼</text>
            <text class="metadata-value">{{item.metadata.value}}{{item.metadata.unit}}</text>
          </view>
          <view class="metadata-item" wx:if="{{item.metadata.abnormal_reason}}">
            <text class="metadata-label">å¼‚å¸¸åŸå› </text>
            <text class="metadata-value error">{{item.metadata.abnormal_reason}}</text>
          </view>
        </view>

        <!-- æ—¶é—´ä¿¡æ¯ -->
        <view class="reminder-time">
          <text class="time-icon">ğŸ•’</text>
          <text class="time-text">{{item.remind_time}}</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="reminder-actions" wx:if="{{item.status === 'pending'}}">
        <button
          class="action-btn ignore"
          catchtap="handleIgnore"
          data-id="{{item.id}}"
        >
          {{useSmartReminders ? 'å¿½ç•¥' : 'åˆ é™¤'}}
        </button>
        <button
          class="action-btn complete"
          catchtap="handleComplete"
          data-id="{{item.id}}"
        >
          æ ‡è®°å®Œæˆ
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!loading && reminders.length === 0}}" class="empty-state">
    <text class="empty-icon">ğŸ“­</text>
    <text class="empty-text">
      {{statusFilter === 'completed' ? 'æš‚æ— å·²å®Œæˆä»»åŠ¡' :
        statusFilter === 'pending' ? 'æš‚æ— å¾…å¤„ç†ä»»åŠ¡' : 'æš‚æ— ä»»åŠ¡æé†’'}}
    </text>
    <button class="add-manual-btn" bindtap="addReminder" wx:if="{{statusFilter === 'all' || statusFilter === 'pending'}}">
      <text class="add-icon">+</text>
      <text>æ·»åŠ æé†’</text>
    </button>
  </view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab-btn" bindtap="addReminder">
    <text class="fab-icon">+</text>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒº -->
  <view class="safe-bottom"></view>
</view>
