# 🔔 智能提醒机制技术方案

## 📋 目录
- [1. 方案概述](#1-方案概述)
- [2. 核心特性](#2-核心特性)
- [3. 系统架构](#3-系统架构)
- [4. 数据库设计](#4-数据库设计)
- [5. 智能算法](#5-智能算法)
- [6. API设计](#6-api设计)
- [7. 前端实现](#7-前端实现)
- [8. 使用指南](#8-使用指南)
- [9. 扩展方向](#9-扩展方向)

---

## 1. 方案概述

### 1.1 背景与目标

共享菜园的租户通常无法实时到场管理菜地，这导致作物管理不及时，影响产量和品质。智能提醒机制通过结合：
- **作物生长规则**：基于科学的种植知识库
- **物联网实时数据**：传感器监测环境状态
- **用户历史行为**：学习用户习惯

提供智能化、个性化的任务提醒，缓解管理不便问题。

### 1.2 核心价值

| 价值点 | 说明 | 效果 |
|--------|------|------|
| **科学种植** | 基于作物生长规律生成提醒 | 提高成活率30%+ |
| **实时预警** | 物联网数据触发环境异常警报 | 减少损失50%+ |
| **省时省力** | 自动计算任务时间，无需人工记忆 | 节省管理时间70%+ |
| **个性化** | 针对不同作物、阶段定制提醒 | 提升用户体验 |

---

## 2. 核心特性

### 2.1 多维度提醒生成

```
智能提醒 = 规则引擎 + 物联网触发 + 手动创建
             ↓            ↓           ↓
          [作物规则]   [传感器]    [用户输入]
             ↓            ↓           ↓
          浇水/施肥    温度/湿度    自定义任务
          除草/治虫    土壤监测        |
          收获提醒    光照检测        ↓
             ↓            ↓        待办事项
             └────────┬───────┘
                      ↓
                  提醒调度引擎
                      ↓
            [优先级排序 + 去重]
                      ↓
                   推送给用户
```

### 2.2 作物生长规则库

支持多种常见作物：

| 作物类型 | 生长阶段 | 关键任务 |
|---------|---------|---------|
| **🍅 番茄** | 播种期→苗期→生长期→开花期→结果期→收获期 | 浇水(2天/次)、施肥(7天/次)、搭架、修剪 |
| **🥬 生菜** | 播种期→苗期→生长期→收获期 | 浇水(1天/次)、施肥(10天/次)、除草 |
| **🥕 胡萝卜** | 播种期→苗期→生长期→收获期 | 浇水(2天/次)、间苗、除草 |
| **🌶️ 辣椒** | 播种期→苗期→生长期→开花期→结果期→收获期 | 浇水(2天/次)、施肥(7天/次)、病虫害防治 |

每个阶段都有详细的：
- 浇水频率和用量
- 施肥类型和频率
- 除草周期
- 病虫害检查
- 特殊操作（搭架、修剪等）

### 2.3 物联网数据对接

支持多种传感器类型：

| 传感器 | 监测指标 | 异常阈值 | 触发提醒 |
|--------|---------|---------|---------|
| **🌡️ 温度传感器** | 环境温度 | <15°C 或 >30°C | "温度异常，注意保温/降温" |
| **💧 湿度传感器** | 空气湿度 | <50% 或 >90% | "湿度异常，调整通风" |
| **🌱 土壤湿度** | 土壤含水量 | <20% 或 >80% | "土壤过干/过湿，调整浇水" |
| **☀️ 光照传感器** | 光照强度 | <2000 lux | "光照不足，考虑补光" |
| **🧪 pH传感器** | 土壤酸碱度 | <6.0 或 >7.5 | "土壤pH异常，需调整" |

### 2.4 智能优先级

提醒按优先级自动排序：

| 优先级 | 级别 | 类型 | 示例 |
|--------|------|------|------|
| **5** | 🔴 紧急 | 环境异常、即将收获 | "温度过低！请采取保温措施" |
| **4** | 🟠 重要 | 物联网预警、临期任务 | "土壤湿度过低，需要浇水" |
| **3** | 🟡 正常 | 常规任务 | "该给番茄施肥了" |
| **2** | 🟢 低优 | 辅助任务 | "建议除草" |
| **1** | ⚪ 提示 | 信息通知 | "记录生长数据" |

---

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────┐
│                     用户层                          │
│  [微信小程序]  →  提醒列表 / 统计看板 / 一键完成     │
└────────────────┬────────────────────────────────────┘
                 │
         API Gateway (FastAPI)
                 │
┌────────────────┴────────────────────────────────────┐
│                    服务层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │
│  │智能提醒引擎  │  │物联网服务    │  │用户服务   │ │
│  │              │  │              │  │           │ │
│  │·规则匹配     │  │·传感器管理   │  │·认证     │ │
│  │·阶段计算     │  │·数据采集     │  │·权限     │ │
│  │·提醒生成     │  │·异常检测     │  │           │ │
│  │·去重优化     │  │·历史查询     │  │           │ │
│  └──────┬───────┘  └──────┬───────┘  └─────┬─────┘ │
└─────────┼──────────────────┼────────────────┼───────┘
          │                  │                │
┌─────────┴──────────────────┴────────────────┴───────┐
│                    数据层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ 作物规则库  │  │ 物联网数据  │  │ 用户数据    │ │
│  │             │  │             │  │             │ │
│  │·作物信息    │  │·传感器读数  │  │·用户信息    │ │
│  │·生长阶段    │  │·设备状态    │  │·种植记录    │ │
│  │·环境需求    │  │·异常记录    │  │·提醒历史    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
│                   MySQL数据库                        │
└─────────────────────────────────────────────────────┘
```

### 3.2 工作流程

```
1. 用户打开提醒页面
   ↓
2. 触发"生成智能提醒"
   ↓
3. 智能引擎分析：
   ├─ 获取用户所有种植记录
   ├─ 更新作物生长阶段
   ├─ 基于规则生成常规提醒
   ├─ 查询物联网传感器数据
   ├─ 检测环境异常并生成预警
   └─ 检查收获时间
   ↓
4. 提醒去重与优先级排序
   ↓
5. 保存到数据库
   ↓
6. 返回给前端展示
   ↓
7. 用户完成/忽略提醒
   ↓
8. 更新状态，记录完成时间
```

---

## 4. 数据库设计

### 4.1 核心表结构

#### 4.1.1 作物基础信息表 (crops)

```sql
CREATE TABLE crops (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '作物名称',
    scientific_name VARCHAR(200) COMMENT '学名',
    type ENUM('vegetable', 'fruit', 'herb', 'grain') COMMENT '作物类型',
    total_growth_days INT COMMENT '总生长周期(天)',
    environment_requirements JSON COMMENT '环境需求',
    difficulty INT DEFAULT 3 COMMENT '种植难度(1-5)',
    common_pests JSON COMMENT '常见病虫害',
    description VARCHAR(500) COMMENT '描述',
    planting_tips VARCHAR(1000) COMMENT '种植技巧',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**environment_requirements JSON示例**:
```json
{
  "temperature": {"min": 15, "max": 25, "optimal": 20},
  "humidity": {"min": 60, "max": 80, "optimal": 70},
  "light_hours": {"min": 6, "max": 8, "optimal": 7},
  "soil_ph": {"min": 6.0, "max": 7.5, "optimal": 6.5}
}
```

#### 4.1.2 作物生长阶段规则表 (crop_growth_stages)

```sql
CREATE TABLE crop_growth_stages (
    id INT PRIMARY KEY AUTO_INCREMENT,
    crop_id INT NOT NULL COMMENT '作物ID',
    stage ENUM('seed', 'seedling', 'growth', 'flowering', 'fruiting', 'harvest'),
    stage_days INT COMMENT '阶段持续天数',
    watering_frequency INT COMMENT '浇水频率(天/次)',
    watering_amount FLOAT COMMENT '浇水量(升)',
    fertilizing_frequency INT COMMENT '施肥频率(天/次)',
    fertilizer_type VARCHAR(100) COMMENT '肥料类型',
    weeding_frequency INT COMMENT '除草频率(天/次)',
    pest_check_frequency INT COMMENT '病虫害检查频率(天/次)',
    other_tasks JSON COMMENT '其他任务',
    stage_tips VARCHAR(500) COMMENT '阶段提示',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.3 种植记录表 (planting_records)

```sql
CREATE TABLE planting_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    garden_id INT NOT NULL COMMENT '菜地ID',
    crop_id INT NOT NULL COMMENT '作物ID',
    user_id INT NOT NULL COMMENT '用户ID',
    planting_date TIMESTAMP COMMENT '种植日期',
    expected_harvest_date TIMESTAMP COMMENT '预计收获日期',
    actual_harvest_date TIMESTAMP COMMENT '实际收获日期',
    current_stage ENUM('seed', 'seedling', 'growth', 'flowering', 'fruiting', 'harvest'),
    current_stage_day INT DEFAULT 1 COMMENT '当前阶段第几天',
    quantity INT COMMENT '种植数量',
    area FLOAT COMMENT '占地面积(㎡)',
    status VARCHAR(20) DEFAULT 'growing' COMMENT '状态',
    notes VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.4 物联网传感器表 (iot_sensors)

```sql
CREATE TABLE iot_sensors (
    id INT PRIMARY KEY AUTO_INCREMENT,
    garden_id INT NOT NULL COMMENT '菜地ID',
    sensor_type VARCHAR(50) NOT NULL COMMENT '传感器类型',
    device_id VARCHAR(100) UNIQUE COMMENT '设备ID',
    location VARCHAR(200) COMMENT '位置',
    is_active INT DEFAULT 1 COMMENT '是否激活',
    last_reading_time TIMESTAMP COMMENT '最后读数时间',
    reading_interval INT DEFAULT 300 COMMENT '读数间隔(秒)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.5 物联网读数表 (iot_readings)

```sql
CREATE TABLE iot_readings (
    id INT PRIMARY KEY AUTO_INCREMENT,
    sensor_id INT NOT NULL,
    value FLOAT NOT NULL COMMENT '读数值',
    unit VARCHAR(20) COMMENT '单位',
    is_abnormal INT DEFAULT 0 COMMENT '是否异常',
    abnormal_reason VARCHAR(200) COMMENT '异常原因',
    reading_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_sensor_time (sensor_id, reading_time)
);
```

#### 4.1.6 智能提醒表 (smart_reminders)

```sql
CREATE TABLE smart_reminders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    garden_id INT COMMENT '菜地ID',
    planting_record_id INT COMMENT '种植记录ID',
    reminder_type VARCHAR(50) NOT NULL COMMENT '提醒类型',
    title VARCHAR(200) NOT NULL COMMENT '标题',
    description VARCHAR(1000) COMMENT '描述',
    remind_time TIMESTAMP NOT NULL COMMENT '提醒时间',
    priority INT DEFAULT 3 COMMENT '优先级(1-5)',
    source VARCHAR(50) COMMENT '来源',
    metadata JSON COMMENT '元数据',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '状态',
    completed_at TIMESTAMP COMMENT '完成时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_status (user_id, status),
    INDEX idx_remind_time (remind_time)
);
```

---

## 5. 智能算法

### 5.1 生长阶段自动更新

```python
def update_growth_stage(planting_record):
    """
    根据种植日期自动计算当前生长阶段
    """
    # 1. 计算种植天数
    days_since_planting = (now - planting_date).days

    # 2. 获取该作物的所有阶段规则
    stages = get_crop_stages(crop_id)

    # 3. 累加天数，确定当前阶段
    accumulated_days = 0
    for stage in stages:
        accumulated_days += stage.stage_days
        if days_since_planting < accumulated_days:
            current_stage = stage
            stage_day = days_since_planting - (accumulated_days - stage.stage_days) + 1
            break

    # 4. 更新记录
    update_record(current_stage, stage_day)
```

### 5.2 规则引擎提醒生成

```python
def generate_rule_based_reminders(planting_record):
    """
    基于作物生长规则生成提醒
    """
    reminders = []
    stage_rule = get_stage_rule(crop_id, current_stage)

    # 浇水提醒
    if stage_rule.watering_frequency:
        last_watering = get_last_completion('watering')
        days_since = (now - last_watering).days

        if days_since >= stage_rule.watering_frequency:
            reminders.append({
                'type': 'watering',
                'title': f'该给{crop_name}浇水了',
                'description': f'建议浇水量：{watering_amount}升',
                'priority': 4
            })

    # 施肥提醒（同理）
    # 除草提醒（同理）
    # 病虫害检查（同理）

    return reminders
```

### 5.3 物联网异常检测

```python
def detect_iot_anomaly(sensor_reading, crop_requirements):
    """
    检测传感器读数是否异常
    """
    sensor_type = sensor.type
    value = reading.value
    requirements = crop_requirements[sensor_type]

    # 温度检测
    if sensor_type == 'temperature':
        if value < requirements['min']:
            return True, f"温度过低，低于{requirements['min']}°C"
        if value > requirements['max']:
            return True, f"温度过高，高于{requirements['max']}°C"

    # 土壤湿度检测
    elif sensor_type == 'soil_moisture':
        if value < 20:
            return True, "土壤过于干燥，需要浇水"
        if value > 80:
            return True, "土壤过于湿润，注意排水"

    return False, None
```

### 5.4 提醒去重算法

```python
def deduplicate_reminders(new_reminder):
    """
    避免重复提醒
    """
    # 查询最近6小时内相同类型的提醒
    existing = query_reminders(
        user_id=user_id,
        type=reminder_type,
        status='pending',
        created_at > now - 6hours
    )

    if existing:
        # 已存在，不创建新的
        return existing

    # 不存在，创建新提醒
    return create_reminder(new_reminder)
```

---

## 6. API设计

### 6.1 API列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 生成智能提醒 | GET | `/api/smart-reminders/generate` | 分析用户数据生成提醒 |
| 获取提醒列表 | GET | `/api/smart-reminders/list` | 获取提醒列表（支持筛选） |
| 完成提醒 | POST | `/api/smart-reminders/complete` | 标记提醒完成 |
| 忽略提醒 | POST | `/api/smart-reminders/ignore/{id}` | 忽略提醒 |
| 获取统计 | GET | `/api/smart-reminders/statistics` | 获取提醒统计数据 |
| 获取IoT状态 | GET | `/api/smart-reminders/iot/status/{garden_id}` | 获取菜地传感器当前状态 |
| 获取IoT历史 | GET | `/api/smart-reminders/iot/history/{garden_id}` | 获取历史数据 |
| 模拟IoT数据 | POST | `/api/smart-reminders/iot/simulate/{garden_id}` | 生成模拟数据（测试用） |

### 6.2 接口详细说明

#### 6.2.1 生成智能提醒

**请求**:
```http
GET /api/smart-reminders/generate
Authorization: Bearer {token}
```

**响应**:
```json
[
  {
    "id": 1,
    "reminder_type": "watering",
    "title": "该给番茄浇水了",
    "description": "建议浇水量：2.5升",
    "remind_time": "2024-12-08T10:00:00",
    "priority": 4,
    "status": "pending",
    "source": "rule_based",
    "metadata": {
      "crop_name": "番茄",
      "growth_stage": "fruiting",
      "watering_amount": 2.5,
      "frequency": 2
    },
    "created_at": "2024-12-08T09:00:00"
  },
  {
    "id": 2,
    "reminder_type": "environment_alert",
    "title": "番茄环境异常警告",
    "description": "温度过低，低于15°C",
    "remind_time": "2024-12-08T09:05:00",
    "priority": 5,
    "status": "pending",
    "source": "iot_triggered",
    "metadata": {
      "crop_name": "番茄",
      "sensor_type": "temperature",
      "value": 12.5,
      "unit": "°C",
      "abnormal_reason": "温度过低，低于15°C"
    },
    "created_at": "2024-12-08T09:05:00"
  }
]
```

#### 6.2.2 获取统计

**请求**:
```http
GET /api/smart-reminders/statistics
Authorization: Bearer {token}
```

**响应**:
```json
{
  "total": 15,
  "pending": 8,
  "completed": 7,
  "by_type": {
    "watering": 3,
    "fertilizing": 2,
    "weeding": 1,
    "environment_alert": 2
  }
}
```

---

## 7. 前端实现

### 7.1 页面结构

```
reminders 页面
├── 统计卡片（智能提醒系统启用时）
│   ├── 待处理数量
│   ├── 已完成数量
│   └── 总计
├── 筛选Tab（全部/待完成/已完成）
└── 提醒列表
    └── 提醒卡片
        ├── 图标 + 标题 + 来源标签
        ├── 优先级徽章
        ├── 描述
        ├── 元数据（浇水量、肥料类型等）
        ├── 时间
        └── 操作按钮（完成/忽略）
```

### 7.2 核心代码

#### 加载智能提醒

```javascript
loadSmartReminders(callback) {
  // 1. 生成智能提醒
  generateSmartReminders()
    .then(() => {
      // 2. 获取列表
      return getSmartReminderList({
        status: this.data.statusFilter
      })
    })
    .then(res => {
      // 3. 格式化数据
      const reminders = res.map(item => ({
        id: item.id,
        task_type: item.reminder_type,
        title: item.title,
        description: item.description,
        remind_time: this.formatTime(item.remind_time),
        status: item.status,
        priority: item.priority,
        source: item.source,
        metadata: item.metadata
      }))

      this.setData({ reminders, loading: false })
      callback && callback()
    })
}
```

#### 完成提醒

```javascript
markComplete(id) {
  completeSmartReminder(id)
    .then(() => {
      wx.showToast({ title: '已完成', icon: 'success' })
      this.loadStatistics()
      this.loadReminders()
    })
}
```

### 7.3 UI特性

#### 优先级视觉区分

```css
/* 紧急提醒 - 红色 */
.reminder-card.priority-5 {
  border-left-color: #FF5722;
  background: #fff5f4;
}

/* 重要提醒 - 橙色 */
.reminder-card.priority-4 {
  border-left-color: #FF9800;
  background: #fffbf5;
}

/* 普通提醒 - 绿色 */
.reminder-card {
  border-left: 6rpx solid #4CAF50;
}
```

#### 来源标签

```html
<view class="source-tag">
  {{item.source === 'iot_triggered' ? '🔔 物联网预警' : '📋 规则生成'}}
</view>
```

---

## 8. 使用指南

### 8.1 初始化作物规则库

```python
# 1. 创建番茄作物
tomato = Crop(
    name="番茄",
    type=CropType.VEGETABLE,
    total_growth_days=90,
    environment_requirements={
        "temperature": {"min": 15, "max": 30, "optimal": 22},
        "humidity": {"min": 60, "max": 80, "optimal": 70},
        "soil_ph": {"min": 6.0, "max": 7.0, "optimal": 6.5}
    },
    common_pests=["白粉病", "蚜虫", "青虫"]
)

# 2. 添加生长阶段规则
stages = [
    CropGrowthStage(crop_id=tomato.id, stage=GrowthStage.SEED,
                    stage_days=7, watering_frequency=1),
    CropGrowthStage(crop_id=tomato.id, stage=GrowthStage.SEEDLING,
                    stage_days=20, watering_frequency=2, fertilizing_frequency=10),
    CropGrowthStage(crop_id=tomato.id, stage=GrowthStage.GROWTH,
                    stage_days=30, watering_frequency=2, fertilizing_frequency=7),
    # ... 其他阶段
]
```

### 8.2 创建种植记录

```python
planting = PlantingRecord(
    garden_id=1,
    crop_id=tomato.id,
    user_id=current_user.id,
    planting_date=datetime.now(),
    expected_harvest_date=datetime.now() + timedelta(days=90),
    current_stage=GrowthStage.SEED,
    quantity=10,
    area=2.0
)
```

### 8.3 配置物联网传感器

```python
# 1. 创建传感器
sensor = IoTService.create_sensor(
    db,
    garden_id=1,
    sensor_type="temperature",
    device_id="TEMP_001"
)

# 2. 记录读数
IoTService.record_reading(
    db,
    sensor_id=sensor.id,
    value=25.3,
    unit="°C"
)

# 3. 模拟数据（测试）
simulated = IoTService.simulate_readings(db, garden_id=1)
```

### 8.4 生成和使用提醒

```python
# 1. 生成智能提醒
reminders = SmartReminderEngine.generate_reminders(db, user_id=1)

# 2. 完成提醒
SmartReminderEngine.complete_reminder(db, reminder_id=1, user_id=1)

# 3. 更新生长阶段
SmartReminderEngine.update_growth_stage(db, planting_record_id=1)
```

---

## 9. 扩展方向

### 9.1 机器学习优化

```python
# 基于历史数据预测最佳浇水时间
def ml_predict_watering_time(historical_data):
    """
    输入：历史浇水记录 + 环境数据
    输出：下次浇水的最佳时间
    """
    # 使用LSTM/随机森林等模型
    model = train_model(historical_data)
    next_time = model.predict(current_conditions)
    return next_time
```

### 9.2 天气API集成

```python
def integrate_weather_data():
    """
    集成天气预报，调整浇水提醒
    """
    weather = get_weather_forecast()

    if weather.rain_probability > 70%:
        # 未来会下雨，取消浇水提醒
        cancel_watering_reminders()

    if weather.temperature < 10:
        # 低温预警
        create_cold_alert()
```

### 9.3 社区知识共享

```python
def share_growing_experience():
    """
    用户可以分享种植经验，丰富规则库
    """
    experience = {
        'crop': '番茄',
        'tip': '苗期适当控水可促进根系发育',
        'rating': 4.5
    }

    # 高评分经验自动加入推荐提醒
    add_community_tip(experience)
```

### 9.4 语音提醒

```python
def voice_reminder():
    """
    通过小程序消息推送语音提醒
    """
    wx.requestSubscribeMessage({
        'tmplIds': ['reminder_template'],
        'success': () => {
            // 推送提醒
            send_template_message()
        }
    })
```

### 9.5 任务自动化

```python
def auto_irrigation():
    """
    集成智能浇水系统，自动执行任务
    """
    if reminder.type == 'watering':
        # 触发物联网设备
        iot_device.start_irrigation(
            duration=calculate_duration(watering_amount)
        )

        # 自动标记完成
        complete_reminder(reminder.id)
```

---

## 📊 总结

### 已实现功能 ✅

1. ✅ **作物生长规则库**：支持多种作物、多个生长阶段
2. ✅ **物联网数据对接**：传感器管理、数据采集、异常检测
3. ✅ **智能提醒引擎**：规则生成 + 物联网触发 + 优先级排序
4. ✅ **完整的API接口**：生成、查询、完成、统计等
5. ✅ **前端智能展示**：统计看板、优先级标识、来源标签

### 技术亮点 ⭐

- **多维度融合**：规则 + IoT + 历史行为
- **自动化程度高**：阶段更新、提醒生成、去重
- **可扩展性强**：支持新增作物、传感器类型
- **用户体验优**：优先级视觉化、一键操作

### 应用价值 💎

- 缓解租户无法实时到场的管理痛点
- 提高作物管理的科学性和及时性
- 降低用户学习成本，提升使用体验
- 为后续AI优化和自动化奠定基础

---

**文档版本**: v1.0
**最后更新**: 2024年12月8日
**作者**: 云端小筑开发团队