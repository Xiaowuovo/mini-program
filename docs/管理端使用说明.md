# 管理端使用说明

## 功能概述

云端小筑管理端提供了完整的后台管理功能，支持菜地资源管理、订单处理、数据统计等核心功能。

## 登录管理端

### 方式一：从登录页面进入

1. 打开小程序，进入登录页面
2. 点击"管理端登录"按钮（橙色按钮）
3. 系统会使用管理员账号登录
4. 登录成功后自动跳转到管理端首页

### 方式二：测试账号

- **账号类型**: 管理员
- **昵称**: 管理员
- **角色**: admin

## 主要功能模块

### 1. 管理后台首页 (Dashboard)

路径: `pages/admin/dashboard/dashboard`

**功能：**
- 数据概览：显示菜地出租率、订单统计、用户活跃度、总收入等关键指标
- 功能菜单：快速访问各个管理模块
- 退出登录：安全退出管理端

**数据展示：**
- 🌱 总菜地数 / 已出租菜地数
- 📋 总订单数 / 待处理订单数
- 👥 注册用户 / 活跃用户
- 💰 总收入 / 本月收入

### 2. 菜地管理

路径: `pages/admin/gardens/gardens`

**功能：**

#### 2.1 菜地列表查看
- 筛选功能：全部、可用、已租、维护中
- 显示信息：菜地名称、位置、面积、价格、状态、当前租户

#### 2.2 添加新菜地
1. 点击"➕ 添加菜地"按钮
2. 填写菜地信息：
   - 名称（如：A区1号地）
   - 位置（如：东区阳光带）
   - 面积（单位：㎡）
   - 价格（单位：元/月）
3. 点击"确定"创建菜地

#### 2.3 修改菜地状态
- 点击"修改状态"按钮
- 选择新状态：可用、已出租、维护中
- 系统自动更新状态

#### 2.4 编辑菜地
- 点击"编辑"按钮
- 修改菜地的详细信息
- 保存更改

**后端API：**
- GET `/gardens` - 获取菜地列表
- POST `/gardens` - 创建菜地（需要管理员权限）
- PUT `/gardens/{id}` - 更新菜地（需要管理员权限）
- DELETE `/gardens/{id}` - 删除菜地（需要管理员权限）

### 3. 订单管理

路径: `pages/admin/orders/orders`

**功能：**

#### 3.1 订单列表
- 筛选功能：全部、待确认、已确认、进行中、已完成、已取消
- 显示信息：订单号、类型、菜地/服务、用户、金额、创建时间

#### 3.2 订单状态管理
1. 点击"更新状态"按钮
2. 根据当前状态选择下一步操作：
   - 待确认 → 已确认 / 已取消
   - 已确认 → 进行中 / 已取消
   - 进行中 → 已完成 / 已取消
3. 系统自动更新订单和菜地状态

#### 3.3 查看订单详情
- 点击"查看详情"查看完整订单信息
- 包括用户信息、菜地信息、时间范围等

**后端API：**
- GET `/orders/admin/all` - 获取所有订单（管理员）
- PUT `/orders/admin/{id}/status` - 更新订单状态（管理员）

### 4. 数据统计

路径: `pages/admin/stats/stats`

**功能：**

#### 4.1 数据总览
- 菜地出租率
- 订单完成率
- 总收入和本月收入
- 用户活跃度

#### 4.2 菜地状态分布
- 可视化展示可用、已租、维护中的菜地数量
- 条形图显示占比

#### 4.3 订单状态分布
- 圆形徽章显示各状态订单数量
- 待确认、已确认、进行中、已完成、已取消

#### 4.4 收入趋势
- 近7日收入折线图
- 直观了解收入变化趋势

#### 4.5 热门菜地 TOP5
- 排行榜显示订单数最多的菜地
- 显示订单数和总收入

### 5. 用户管理

路径: `pages/admin/users/users`

**功能：**

#### 5.1 用户列表
- 搜索功能：支持昵称和手机号搜索
- 筛选功能：全部、租户、管理员
- 显示信息：头像、昵称、角色、手机号、注册时间、订单数

#### 5.2 用户详情
- 点击用户卡片查看详细信息
- 查看用户的订单历史

## 权限说明

### 管理员权限
- ✅ 访问管理端所有功能
- ✅ 创建、编辑、删除菜地
- ✅ 查看和管理所有订单
- ✅ 更新订单状态
- ✅ 查看统计数据
- ✅ 管理用户信息

### 普通用户权限
- ❌ 无法访问管理端
- ❌ 无法查看其他用户的订单
- ✅ 只能查看和管理自己的菜地和订单

## 技术实现

### 前端
- **框架**: 微信小程序原生框架
- **页面路由**: 通过 `app.json` 注册
- **权限验证**: 前端检查用户角色，后端API双重验证

### 后端
- **框架**: FastAPI (Python)
- **权限控制**: 使用依赖注入 `get_current_admin`
- **数据库**: SQLAlchemy ORM

### 权限验证流程
```
用户登录 → JWT Token →
前端检查 role 字段 →
后端 API 使用 get_current_admin 验证 →
返回数据或403错误
```

## 开发说明

### 前端页面结构
```
miniprogram/pages/admin/
├── dashboard/          # 管理后台首页
│   ├── dashboard.js
│   ├── dashboard.wxml
│   ├── dashboard.wxss
│   └── dashboard.json
├── gardens/            # 菜地管理
│   ├── gardens.js
│   ├── gardens.wxml
│   ├── gardens.wxss
│   └── gardens.json
├── orders/             # 订单管理
│   ├── orders.js
│   ├── orders.wxml
│   ├── orders.wxss
│   └── orders.json
├── stats/              # 数据统计
│   ├── stats.js
│   ├── stats.wxml
│   ├── stats.wxss
│   └── stats.json
└── users/              # 用户管理
    ├── users.js
    ├── users.wxml
    ├── users.wxss
    └── users.json
```

### 后端API权限控制
```python
# 普通用户依赖
current_user: User = Depends(get_current_user)

# 管理员依赖
current_user: User = Depends(get_current_admin)
```

## 未来扩展

### 可选功能
1. **通知推送**: 订单状态变更时通知用户
2. **数据导出**: 导出订单和收入报表
3. **批量操作**: 批量更新菜地状态
4. **高级统计**: 更多维度的数据分析
5. **日志审计**: 记录管理员操作日志

### 独立管理后台
如果需要更强大的管理功能，可以开发独立的Web管理后台：
- 使用 React/Vue 开发
- 更丰富的图表展示
- 更复杂的权限管理
- 更多的业务功能

## 注意事项

1. **权限安全**: 管理员账号应妥善保管，避免泄露
2. **数据备份**: 定期备份数据库
3. **操作日志**: 重要操作应记录日志
4. **测试环境**: 在正式环境操作前，先在测试环境验证

## 常见问题

### Q: 如何创建管理员账号？
A: 通过后端 `/auth/test-login` 接口，设置 `role='admin'` 即可创建管理员账号。

### Q: 普通用户能否升级为管理员？
A: 需要在数据库中手动修改用户的 `role` 字段，或通过后端管理接口实现。

### Q: 管理端数据是实时的吗？
A: 是的，所有数据都是实时从后端API获取的。

### Q: 如何退出管理端？
A: 在管理后台首页点击右上角的"退出"按钮即可退出登录。

---

**文档版本**: 1.0
**更新日期**: 2024-12-10
**维护者**: 开发团队
