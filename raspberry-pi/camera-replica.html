<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>è¿œç¨‹æ‘„åƒå¤´</title>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.3/adapter.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="settings.js"></script>
<script type="text/javascript" src="janus.js"></script>
<style>
* { margin: 0; padding: 0; }
body { background: #000; }
#remotecontainer { width: 100vw; height: 100vh; }
video { width: 100%; height: 100%; object-fit: contain; }
audio { display: none; }
#status {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.9); color: #4CAF50;
    padding: 10px 20px; border-radius: 20px; z-index: 1000;
}
</style>
</head>
<body>
<div id="status">ğŸ”´ åˆå§‹åŒ–ä¸­...</div>
<div id="remotecontainer"></div>

<script type="text/javascript">
var myroom = 1234;
var janus = null;
var remoteFeed = null;
var remoteTracks = {};

$(document).ready(function() {
    Janus.init({
        debug: "all",
        callback: function() {
            $('#status').text('ğŸŸ¢ åˆå§‹åŒ–æˆåŠŸ');

            // â­ ä½¿ç”¨ä½ çš„ TURN æœåŠ¡å™¨
            janus = new Janus({
                server: server,
                iceServers: [
                    {
                        urls: "turn:124.222.14.2:3478",
                        username: "admin",
                        credential: "123456"
                    },
                    {
                        urls: "turn:124.222.14.2:3478?transport=tcp",
                        username: "admin",
                        credential: "123456"
                    }
                ],
                success: function() {
                    $('#status').text('ğŸŸ¢ å·²è¿æ¥');
                    janus.attach({
                        plugin: "janus.plugin.videoroom",
                        opaqueId: "subscriber-" + Janus.randomString(12),
                        success: function(pluginHandle) {
                            remoteFeed = pluginHandle;
                            Janus.log("Plugin attached! id=" + remoteFeed.getId());
                            $('#status').text('ğŸŸ¢ æ’ä»¶é™„åŠ æˆåŠŸ');

                            // è·å–å‚ä¸è€…
                            var list = { request: "listparticipants", room: myroom };
                            remoteFeed.send({
                                message: list,
                                success: function(result) {
                                    if(result && result.participants) {
                                        Janus.log("Participants:", result.participants);
                                        for(var i in result.participants) {
                                            var p = result.participants[i];
                                            if(p.publisher === true) {
                                                $('#status').text('ğŸŸ¢ å‘ç°å‘å¸ƒè€…');
                                                subscribe(p.id, p.streams);
                                                break;
                                            }
                                        }
                                    }
                                }
                            });
                        },
                        error: function(error) {
                            Janus.error("Error attaching plugin", error);
                            $('#status').text('ğŸ”´ æ’ä»¶é”™è¯¯');
                        },
                        onmessage: function(msg, jsep) {
                            Janus.debug("Got message", msg);
                            if(jsep) {
                                Janus.debug("Handling SDP", jsep);
                                remoteFeed.createAnswer({
                                    jsep: jsep,
                                    tracks: [
                                        { type: 'data' },
                                    ],
                                    success: function(jsep) {
                                        Janus.debug("Got SDP", jsep);
                                        var body = { request: "start", room: myroom };
                                        remoteFeed.send({ message: body, jsep: jsep });
                                        $('#status').text('ğŸŸ¢ ç­‰å¾…è§†é¢‘æµ...');
                                    },
                                    error: function(error) {
                                        Janus.error("WebRTC error", error);
                                        $('#status').text('ğŸ”´ WebRTCé”™è¯¯');
                                    }
                                });
                            }
                        },
                        onlocaltrack: function(track, on) {
                            // è®¢é˜…è€…ä¸éœ€è¦
                        },
                        onremotetrack: function(track, mid, on, metadata) {
                            Janus.debug(
                                "Remote track (mid=" + mid + ") " +
                                (on ? "added" : "removed") +
                                (metadata ? " (" + metadata.reason + ") " : "") + ":", track
                            );

                            if(!on) {
                                $('#remote-' + mid).remove();
                                delete remoteTracks[mid];
                                return;
                            }

                            if($('#remote-' + mid).length > 0) {
                                return;
                            }

                            if(track.kind === "audio") {
                                var stream = new MediaStream([track]);
                                remoteTracks[mid] = stream;
                                Janus.log("Created remote audio stream:", stream);
                                $('#remotecontainer').append(
                                    '<audio id="remote-' + mid + '" autoplay playsinline/>'
                                );
                                Janus.attachMediaStream($('#remote-' + mid).get(0), stream);
                                $('#status').text('ğŸ”´ éŸ³é¢‘æ’­æ”¾ä¸­');
                            } else {
                                var stream = new MediaStream([track]);
                                remoteTracks[mid] = stream;
                                Janus.log("Created remote video stream:", stream);
                                $('#remotecontainer').append(
                                    '<video id="remote-' + mid + '" autoplay playsinline/>'
                                );
                                Janus.attachMediaStream($('#remote-' + mid).get(0), stream);
                                $('#status').text('ğŸ”´ è§†é¢‘æ’­æ”¾ä¸­');
                            }
                        }
                    });
                },
                error: function(error) {
                    Janus.error(error);
                    $('#status').text('ğŸ”´ è¿æ¥å¤±è´¥');
                },
                destroyed: function() {
                    window.location.reload();
                }
            });
        }
    });
});

function subscribe(feedId, streams) {
    Janus.log("Subscribing to feed:", feedId);
    var body = {
        request: "join",
        room: myroom,
        ptype: "subscriber",
        feed: feedId
    };
    if(streams)
        body.streams = streams;
    remoteFeed.send({ message: body });
}
</script>
</body>
</html>
