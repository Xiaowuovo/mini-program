<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿œç¨‹æ‘„åƒå¤´</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.3/adapter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="janus.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        body { background: #000; overflow: hidden; }
        #videocontainer { width: 100vw; height: 100vh; position: relative; }
        video { width: 100%; height: 100%; object-fit: contain; }
        audio { display: none; }
        #status {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #4CAF50;
            padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="status">ğŸ”´ åˆå§‹åŒ–ä¸­...</div>
    <div id="videocontainer"></div>

    <script>
        const ROOM_ID = 1234;
        const SERVER = "https://124.222.14.2:8089/janus";

        let janus, remoteFeed;
        let remoteTracks = {};

        function log(msg) {
            console.log('[LOG]', msg);
            $('#status').text(msg);
        }

        $(document).ready(function() {
            Janus.init({
                debug: "all",
                callback: function() {
                    log('ğŸŸ¢ åˆå§‹åŒ–æˆåŠŸ');

                    janus = new Janus({
                        server: SERVER,
                        success: function() {
                            log('ğŸŸ¢ å·²è¿æ¥');
                            attachSubscriber();
                        }
                    });
                }
            });
        });

        function attachSubscriber() {
            janus.attach({
                plugin: "janus.plugin.videoroom",
                success: function(pluginHandle) {
                    remoteFeed = pluginHandle;
                    log('ğŸŸ¢ æ’ä»¶é™„åŠ æˆåŠŸ');

                    // è·å–å‚ä¸è€…
                    remoteFeed.send({
                        message: { request: "listparticipants", room: ROOM_ID },
                        success: function(result) {
                            const list = result.participants || [];
                            if (list.length > 0 && list[0].publisher) {
                                log('ğŸŸ¢ å‘ç°å‘å¸ƒè€…');
                                subscribe(list[0].id);
                            } else {
                                log('âš ï¸ æ— å‘å¸ƒè€…');
                            }
                        }
                    });
                },
                onmessage: function(msg, jsep) {
                    if (jsep) {
                        remoteFeed.createAnswer({
                            jsep: jsep,
                            tracks: [
                                { type: 'audio', capture: false, recv: true },
                                { type: 'video', capture: false, recv: true }
                            ],
                            success: function(jsep) {
                                remoteFeed.send({
                                    message: { request: "start" },
                                    jsep: jsep
                                });
                                log('ğŸŸ¢ ç­‰å¾…è§†é¢‘...');
                            }
                        });
                    }
                },
                onremotetrack: function(track, mid, on) {
                    console.log('Track ' + (on ? 'added' : 'removed') + ':', track.kind, 'mid:', mid);

                    if (!on) {
                        $('#remote-' + mid).remove();
                        delete remoteTracks[mid];
                        return;
                    }

                    // ä¸ºæ¯ä¸ªtrackåˆ›å»ºç‹¬ç«‹çš„streamå’Œå…ƒç´ 
                    let stream = new MediaStream([track]);
                    remoteTracks[mid] = stream;

                    if (track.kind === 'audio') {
                        $('#videocontainer').append('<audio id="remote-' + mid + '" autoplay/>');
                        Janus.attachMediaStream($('#remote-' + mid).get(0), stream);
                        log('ğŸ”´ éŸ³é¢‘æ’­æ”¾ä¸­');
                    } else {
                        $('#videocontainer').append('<video id="remote-' + mid + '" autoplay playsinline/>');
                        Janus.attachMediaStream($('#remote-' + mid).get(0), stream);
                        log('ğŸ”´ è§†é¢‘æ’­æ”¾ä¸­');
                    }
                }
            });
        }

        function subscribe(feedId) {
            log('ğŸŸ¢ è®¢é˜… ' + feedId);
            remoteFeed.send({
                message: {
                    request: "join",
                    room: ROOM_ID,
                    ptype: "subscriber",
                    feed: feedId
                }
            });
        }
    </script>
</body>
</html>
