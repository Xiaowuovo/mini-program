<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿œç¨‹æ‘„åƒå¤´</title>

    <!-- ä¾èµ–åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.3/adapter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="janus.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; font-family: Arial, sans-serif; }
        #videoremote { width: 100vw; height: 100vh; object-fit: contain; background: #000; }
        #status {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: #4CAF50;
            padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; text-align: center;
        }
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #4CAF50;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="status">ğŸ”´ åˆå§‹åŒ–ä¸­...</div>
    <div class="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨è¿æ¥...</div>
    </div>
    <video id="videoremote" autoplay playsinline muted></video>

    <script>
        // ========== é…ç½®åŒºåŸŸ ==========
        const ROOM_ID = 1234;  // â­ ä½ çš„æˆ¿é—´å·
        const SERVER_URL = "https://124.222.14.2:8089/janus";  // â­ ä½¿ç”¨REST APIæ–¹å¼

        // ========== å…¨å±€å˜é‡ ==========
        let janus = null;
        let videoroom = null;
        let myid = null;
        let mypvtid = null;

        // ========== å·¥å…·å‡½æ•° ==========
        function log(msg) {
            console.log('[LOG]', msg);
            document.getElementById('status').textContent = msg;
        }

        function hideLoading() {
            const loading = document.querySelector('.loading');
            if (loading) loading.style.display = 'none';
        }

        // ========== åˆå§‹åŒ– ==========
        $(document).ready(function() {
            // æ£€æŸ¥ä¾èµ–
            if (typeof adapter === 'undefined') {
                log('ğŸ”´ adapter.jsæœªåŠ è½½');
                alert('é”™è¯¯ï¼šadapter.jsæœªåŠ è½½ï¼');
                return;
            }

            if (typeof Janus === 'undefined') {
                log('ğŸ”´ janus.jsæœªåŠ è½½');
                alert('é”™è¯¯ï¼šjanus.jsæœªåŠ è½½ï¼è¯·ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®ã€‚');
                return;
            }

            log('ğŸŸ¢ æ­£åœ¨åˆå§‹åŒ–...');

            // åˆå§‹åŒ–Janusåº“
            Janus.init({
                debug: "all",
                dependencies: Janus.useDefaultDependencies(),
                callback: function() {
                    log('ğŸŸ¢ Janusåˆå§‹åŒ–æˆåŠŸ');
                    connectToJanus();
                }
            });
        });

        // ========== è¿æ¥JanusæœåŠ¡å™¨ ==========
        function connectToJanus() {
            log('ğŸŸ¢ è¿æ¥JanusæœåŠ¡å™¨...');

            janus = new Janus({
                server: SERVER_URL,
                success: function() {
                    log('ğŸŸ¢ å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    attachVideoRoom();
                },
                error: function(error) {
                    log('ğŸ”´ è¿æ¥å¤±è´¥');
                    console.error('è¿æ¥é”™è¯¯:', error);

                    // å¦‚æœHTTP APIå¤±è´¥ï¼Œæç¤ºç”¨æˆ·
                    setTimeout(function() {
                        alert('è¿æ¥å¤±è´¥ï¼\n\nå¯èƒ½åŸå› ï¼š\n1. Nginxé…ç½®é—®é¢˜\n2. éœ€è¦ä½¿ç”¨WebSocket\n\nè¯·æ£€æŸ¥é…ç½®æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                    }, 1000);
                },
                destroyed: function() {
                    log('ğŸ”´ è¿æ¥æ–­å¼€');
                }
            });
        }

        // ========== é™„åŠ VideoRoomæ’ä»¶ ==========
        function attachVideoRoom() {
            log('ğŸŸ¢ é™„åŠ VideoRoomæ’ä»¶...');

            janus.attach({
                plugin: "janus.plugin.videoroom",
                opaqueId: "subscriber-" + Janus.randomString(12),
                success: function(pluginHandle) {
                    videoroom = pluginHandle;
                    log('ğŸŸ¢ æ’ä»¶é™„åŠ æˆåŠŸ');
                    joinRoom();
                },
                error: function(error) {
                    log('ğŸ”´ æ’ä»¶é™„åŠ å¤±è´¥');
                    console.error('æ’ä»¶é”™è¯¯:', error);
                },
                onmessage: function(msg, jsep) {
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', msg);

                    const event = msg["videoroom"];

                    // â­ å¤„ç†å‚ä¸è€…åˆ—è¡¨å“åº”
                    if (event === "participants") {
                        const participants = msg["participants"] || [];
                        log('ğŸŸ¢ æˆ¿é—´ä¸­æœ‰ ' + participants.length + ' ä¸ªå‚ä¸è€…');
                        console.log('âœ… å‚ä¸è€…è¯¦æƒ…:', participants);  // è°ƒè¯•

                        // æ‰¾åˆ°å‘å¸ƒè€…ï¼ˆpublisher: true æˆ– æœ‰ publisher å­—æ®µï¼‰
                        const publishers = participants.filter(p => p.publisher === true || p.publisher !== undefined);
                        console.log('âœ… å‘å¸ƒè€…åˆ—è¡¨:', publishers);  // è°ƒè¯•

                        if (publishers.length > 0) {
                            const publisher = publishers[0];
                            console.log('âœ… å‡†å¤‡è®¢é˜…å‘å¸ƒè€…:', publisher);  // è°ƒè¯•
                            log('ğŸŸ¢ å‘ç°æ‘„åƒå¤´ ID: ' + publisher.id);
                            subscribeTo(publisher);
                        } else {
                            log('âš ï¸ æˆ¿é—´ä¸­æš‚æ— å‘å¸ƒè€…');
                        }
                        return;
                    }

                    // åŠ å…¥æˆ¿é—´æˆåŠŸï¼ˆè®¢é˜…è€…åŠ å…¥æˆåŠŸï¼‰
                    if (event === "attached") {
                        myid = msg["id"];
                        log('ğŸŸ¢ å·²é™„åŠ åˆ°å‘å¸ƒè€…');
                    }

                    // è®¢é˜…æˆåŠŸ
                    if (event === "joined") {
                        myid = msg["id"];
                        mypvtid = msg["private_id"];
                        log('ğŸŸ¢ è®¢é˜…æˆåŠŸ');
                    }

                    // æ–°å‘å¸ƒè€…åŠ å…¥
                    if (msg["publishers"]) {
                        const publishers = msg["publishers"];
                        if (publishers.length > 0) {
                            log('ğŸŸ¢ æ–°æ‘„åƒå¤´ä¸Šçº¿');
                            subscribeTo(publishers[0]);
                        }
                    }

                    // å‘å¸ƒè€…ç¦»å¼€
                    if (msg["leaving"]) {
                        log('âš ï¸ æ‘„åƒå¤´ç¦»çº¿');
                    }

                    // å¤„ç†JSEP
                    if (jsep) {
                        videoroom.handleRemoteJsep({ jsep: jsep });
                    }
                },
                onremotestream: function(stream) {
                    log('ğŸ”´ æ­£åœ¨æ’­æ”¾');
                    hideLoading();

                    const video = document.getElementById('videoremote');
                    Janus.attachMediaStream(video, stream);

                    // è‡ªåŠ¨æ’­æ”¾
                    video.play().catch(function(error) {
                        console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œå°è¯•é™éŸ³æ’­æ”¾:', error);
                        video.muted = true;
                        video.play();
                    });
                },
                oncleanup: function() {
                    log('æ¸…ç†è¿æ¥');
                }
            });
        }

        // ========== åŠ å…¥æˆ¿é—´ ==========
        function joinRoom() {
            log('ğŸŸ¢ åŠ å…¥æˆ¿é—´ ' + ROOM_ID + '...');

            // â­ ä¿®å¤ï¼šè®¢é˜…è€…éœ€è¦å…ˆä»¥ listener æ–¹å¼åŠ å…¥
            const joinMsg = {
                request: "listparticipants",  // å…ˆè·å–æˆ¿é—´å‚ä¸è€…åˆ—è¡¨
                room: ROOM_ID
            };

            videoroom.send({ message: joinMsg });
        }

        // ========== è®¢é˜…å‘å¸ƒè€… ==========
        function subscribeTo(publisher) {
            console.log('å¼€å§‹è®¢é˜…ï¼Œå‘å¸ƒè€…æ•°æ®:', publisher);  // è°ƒè¯•

            const feedId = publisher.id;
            if (!feedId) {
                log('ğŸ”´ é”™è¯¯ï¼šå‘å¸ƒè€…IDä¸ºç©º');
                console.error('å‘å¸ƒè€…å¯¹è±¡:', publisher);
                return;
            }

            log('ğŸŸ¢ è®¢é˜…å‘å¸ƒè€… ID: ' + feedId + ' (' + (publisher.display || 'æœªå‘½å') + ')');

            const subscribeMsg = {
                request: "join",
                room: ROOM_ID,
                ptype: "subscriber",
                feed: feedId
            };

            console.log('å‘é€è®¢é˜…æ¶ˆæ¯:', subscribeMsg);  // è°ƒè¯•
            videoroom.send({ message: subscribeMsg });
        }

        // ========== é¡µé¢å¸è½½æ—¶æ¸…ç† ==========
        window.onbeforeunload = function() {
            if (janus) {
                janus.destroy();
            }
        };
    </script>
</body>
</html>
