<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿œç¨‹æ‘„åƒå¤´</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.3/adapter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="../janus.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; }
        #videoremote { width: 100vw; height: 100vh; object-fit: contain; }
        #status {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: #4CAF50;
            padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 1000;
        }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; text-align: center; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #4CAF50; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="status">ğŸ”´ åˆå§‹åŒ–ä¸­...</div>
    <div class="loading"><div class="spinner"></div><div>æ­£åœ¨è¿æ¥...</div></div>
    <video id="videoremote" autoplay playsinline muted></video>

    <script>
        // é…ç½®ï¼šç›´æ¥ä½¿ç”¨Janusçš„WebSocketç«¯å£ï¼ˆç»•è¿‡Nginxï¼‰
        const ROOM_ID = 10001;
        const WS_SERVER = "wss://124.222.14.2:8989";  // â­ ç›´æ¥è¿Janusçš„WSSç«¯å£

        let janus = null, videoroom = null, myid = null, mypvtid = null;

        function log(msg) {
            console.log('[LOG]', msg);
            document.getElementById('status').textContent = msg;
        }

        function hideLoading() {
            const loading = document.querySelector('.loading');
            if (loading) loading.style.display = 'none';
        }

        $(document).ready(function() {
            if (typeof adapter === 'undefined' || typeof Janus === 'undefined') {
                log('ğŸ”´ ä¾èµ–æœªåŠ è½½'); return;
            }

            log('ğŸŸ¢ æ­£åœ¨åˆå§‹åŒ–...');

            Janus.init({
                debug: "all",
                dependencies: Janus.useDefaultDependencies(),
                callback: function() {
                    log('ğŸŸ¢ Janusåˆå§‹åŒ–æˆåŠŸ');

                    janus = new Janus({
                        server: WS_SERVER,
                        success: function() {
                            log('ğŸŸ¢ å·²è¿æ¥æœåŠ¡å™¨');
                            attachVideoRoom();
                        },
                        error: function(error) {
                            log('ğŸ”´ è¿æ¥å¤±è´¥: ' + error);
                            console.error(error);
                        }
                    });
                }
            });
        });

        function attachVideoRoom() {
            janus.attach({
                plugin: "janus.plugin.videoroom",
                success: function(pluginHandle) {
                    videoroom = pluginHandle;
                    log('ğŸŸ¢ æ’ä»¶é™„åŠ æˆåŠŸ');

                    videoroom.send({
                        message: {
                            request: "join",
                            room: ROOM_ID,
                            ptype: "subscriber"
                        }
                    });
                },
                error: function(error) {
                    log('ğŸ”´ æ’ä»¶é”™è¯¯: ' + error);
                },
                onmessage: function(msg, jsep) {
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', msg);

                    if (msg["videoroom"] === "joined") {
                        myid = msg["id"];
                        mypvtid = msg["private_id"];
                        log('ğŸŸ¢ å·²åŠ å…¥æˆ¿é—´');

                        if (msg["publishers"] && msg["publishers"].length > 0) {
                            log('ğŸŸ¢ å‘ç°æ‘„åƒå¤´');
                            subscribeTo(msg["publishers"][0]);
                        } else {
                            log('âš ï¸ ç­‰å¾…æ‘„åƒå¤´...');
                        }
                    }

                    if (msg["publishers"]) {
                        const pubs = msg["publishers"];
                        if (pubs.length > 0) subscribeTo(pubs[0]);
                    }

                    if (jsep) {
                        videoroom.handleRemoteJsep({ jsep: jsep });
                    }
                },
                onremotestream: function(stream) {
                    log('ğŸ”´ æ­£åœ¨æ’­æ”¾');
                    hideLoading();
                    Janus.attachMediaStream(document.getElementById('videoremote'), stream);
                }
            });
        }

        function subscribeTo(publisher) {
            log('ğŸŸ¢ è®¢é˜…: ' + (publisher.display || 'æ‘„åƒå¤´'));
            videoroom.send({
                message: {
                    request: "join",
                    room: ROOM_ID,
                    ptype: "subscriber",
                    feed: publisher.id,
                    private_id: mypvtid
                }
            });
        }

        window.onbeforeunload = function() {
            if (janus) janus.destroy();
        };
    </script>
</body>
</html>
